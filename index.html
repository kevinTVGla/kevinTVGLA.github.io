<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<!-- <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"> -->
	<meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
	<title>HBO AR.js Prototype</title>

	<link rel="stylesheet" href="css/main.min.css" />
	<!--<script src="https://use.fontawesome.com/bac49b7ee8.js"></script>-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="js/main.min.js"></script>
	<!-- include A-Frame -->
	<script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
	<!-- include AR.js -->
    <script src="https://rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <!-- include Extra Loaders -->
    <script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <!-- import events.js script -->
    <script src="https://rawgit.com/nicolocarpignoli/nicolocarpignoli.github.io/master/ar-playground/events.js"></script>
    
</head>
<body style="margin: 0; overflow: hidden;">
	<!-- inflate.min.js for FBX --> 
    <script src="/js/inflate.min.js"></script>

	<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
		
	<a-assets>
		<!-- <a-asset-item id="drone-asset" src="/models/scene.gltf"></a-asset-item> -->
		<!-- <a-asset-item id="dragon-asset-glb" src="/models/dragon/dragon.glb"></a-asset-item> -->
		<!-- <a-asset-item id="dragon-asset-fbx" src="/models/dragonloop/dragonloop.fbx"></a-asset-item> -->
	</a-assets>

    <!-- <a-marker preset="hiro" emitevents="true" value='6'>
    	<a-entity 
    		id="drone" 
    		position="0 0 0"
    		gltf-model="#drone-asset"
    		animation-mixer
    		scale="0.01 0.01 0.01"
    		>
	     </a-entity>
    </a-marker>  -->
    <a-marker type='pattern' patternUrl='/img/pattern-marker.patt' emitevents='true' value='6'>
    	<a-entity 
    		id="dragon" 
    		position="0 0 0"
    		fbx-model="src: url(/models/dragonloop/dragonloop.fbx);"
    		animation-mixer
    		scale="0.1 0.1 0.1"
    		>
	     </a-entity>
    </a-marker> 

    <!-- <a-marker preset="hiro" emitevents="true" value='6'>
    	<a-entity 
    		id="dragon" 
    		position="0 0 0"
    		fbx-model="src: url(/models/dragonloop/dragon_loop.fbx);"
    		animation-mixer
    		scale="0.1 0.1 0.1"
    		>
	     </a-entity>
    </a-marker>  -->

    <a-entity camera></a-entity>
		
	</a-scene>
</body>
<script type="text/javascript">
	AFRAME.registerComponent("listener", {
	  init: function() {
	    this.target = document.querySelector('#dragon'); // your model
	    this.prevPosition = null; // initially there is no position or rotation
	    this.prevRotation = null;
	  },

	  tick: function() {
	    if (this.el.object3D.visible) {
	      this.target.setAttribute('visible', 'true')

	      if(!this.prevPosition && !this.prevRotation) { 
	        // there are no values to lerp from - set the initial values
	        this.target.setAttribute('position', this.el.getAttribute('position'))
	        this.target.setAttribute('rotation', this.el.getAttribute('rotation'))
	      } else {
	        // use the previous values to get an approximation 
	        this.target.object3D.position.lerp(this.prevPosition, 0.1)

	        // this (below) may seem ugly, but the rotation is a euler, not a THREE.Vector3, 
	        // so to use the lerp function i'm doing some probably unnecessary conversions
	        let rot = this.target.object3D.rotation.toVector3().lerp(this.prevRotation, 0.1)
	        this.target.object3D.rotation.setFromVector3(rot)
	      }
	      // update the values
	      this.prevPosition = this.el.object3D.position
	      this.prevRotation = this.el.object3D.rotation
	    } else {
	     // the marker dissapeared - reset the values
	     this.target.setAttribute('visible', 'false')
	     this.prevPosition = null;
	     this.prevRotation = null;
	   }
	  }
	})
</script>
</html>
